# -----------------------------------------------
# Stage 1 — Build stage (install dependencies)
# -----------------------------------------------
# Use a lightweight, LTS Node.js base image for better security & stability
FROM node:18-alpine AS build

# Set working directory inside the container
WORKDIR /opt/server

# Copy only package.json and package-lock.json first for better caching
COPY package*.json ./

# Install dependencies (no dev dependencies for production)
RUN npm ci --only=production

# Copy the rest of the application code
COPY . .

# -----------------------------------------------
# Stage 2 — Runtime stage (final production image)
# -----------------------------------------------
# Use a minimal runtime image to reduce size and attack surface
FROM node:18-alpine

# Set environment variables for production
ENV NODE_ENV=production
ENV INSTANA_AUTO_PROFILE=true

# Create app directory
WORKDIR /opt/server

# Copy dependencies and app code from the build stage
COPY --from=build /opt/server /opt/server

# Expose the port that your app listens on
EXPOSE 8080

# Use a non-root user for better security
RUN addgroup -S appgroup && adduser -S appuser -G appgroup
USER appuser

# Start the Node.js application
CMD ["node", "server.js"]
