# -----------------------------------------------
# Stage 1 — Base image
# -----------------------------------------------
# Use a lightweight official Python image
FROM python:3.12-slim AS base

# Prevents Python from writing .pyc files to disk
ENV PYTHONDONTWRITEBYTECODE=1

# Ensures stdout/stderr are unbuffered (for logs to appear in Docker logs)
ENV PYTHONUNBUFFERED=1

# Set working directory
WORKDIR /app

# Install security updates and essential packages
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential && \
    rm -rf /var/lib/apt/lists/*

# -----------------------------------------------
# Stage 2 — Install dependencies
# -----------------------------------------------
# Copy requirements.txt first for better Docker caching
COPY requirements.txt .

# Install dependencies securely and efficiently
RUN pip install --no-cache-dir -r requirements.txt

# -----------------------------------------------
# Stage 3 — Copy application files
# -----------------------------------------------
# Copy application code
COPY . .

# Expose the app port
EXPOSE 8081

# Create a non-root user for security
RUN useradd -m appuser
USER appuser

# -----------------------------------------------
# Stage 4 — Start the application
# -----------------------------------------------
# Default command
CMD ["python", "app.py"]
